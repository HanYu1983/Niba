<div
  id="input"
  style="border: 1px solid black; display: flex; flex-wrap: wrap"
></div>
<div id="output"></div>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
  integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/datalib/1.9.3/datalib.min.js"
  integrity="sha512-0Wxch7yEHpq8eszzwYYczf6VJxBz9pDsx/K2LirpZ05WgDaoo7BK6uap/osDV21OO1KGNFhKJ2ujZXm0vk18pg=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"
  integrity="sha512-csNcFYJniKjJxRWRV1R7fvnXrycHP6qDR21mgz1ZP55xY5d+aHLfo9/FcGDQLfn2IfngbAHd8LdfsagcCqgTcQ=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"
  integrity="sha512-xQBQYt9UcgblF6aCMrwU1NkVA7HCXaSN2oq0so80KO+y68M+n64FOcqgav4igHe6D5ObBLIf68DWv+gfBowczg=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>

<script>
  function weightView() {
    return `<div style="flex: 1; background: white; border: 2px solid black"></div>`;
  }
  function cardView({
    id,
    title,
    weight,
    attackType,
    outsidePower,
    insidePower,
    skillType,
    skillCost,
    skillName,
    skillText,
    skillMana,
    color,
  }) {
    const W = 260 * 0.8;
    const H = 390 * 0.8;
    return `
<div style="width: ${W}px; height: ${H}px; background:${color};">
  <div style="font-size: 25px; text-align: center;">${title}</div>
  <div style="display:flex; justify-content: center; align-items: center;">
    <div style="flex: 1; background: white">
      <div style="font-size: 60px">${outsidePower}</div>
    </div>
    <div style="flex: 3; background: yellow">
      <div style="display:flex; height: 10px">
        ${[...new Array(weight).keys()].map(weightView).join("")}
      </div>
      <div style="display:flex; justify-content: center">
        <img src="images/blade.png" style="height: ${150 * 0.8}px">
        <div style="font-size: 3px;">${id}</div>   
      </div>
      <div style="display:flex; height: 10px">
        ${[...new Array(weight).keys()].map(weightView).join("")}
      </div>
    </div>
    <div style="flex: 1; background: white">
      <div style="font-size: 60px; text-align: center">${insidePower}</div>
    </div>
  </div>
  <div style="display:flex">
    <div style="flex: 1">
      <div style="font-size: 12px; text-align: center">${skillName}</div>
    </div>
    <div style="flex: 1">
      <div style="font-size: 12px; text-align: center">${skillCost}</div>
    </div>
    <div style="flex: 1">
      <div style="font-size: 12px; text-align: center">${skillMana}</div>
    </div>
  </div>
  <div style="font-size: 10px; text-align: center">${skillText}</div>
</div>
`;
  }

  const rows = dl.tsv("格鬥風雲錄2 - main.tsv").slice(0, 100);

  function draw() {
    // const params = new URLSearchParams(window.location.search);
    rows.forEach((row) => {
      const colorMapping = {
        近招: "red",
        遠招: "yellow",
        氣功: "white",
        氣場: "LightGray",
        防招: "green",
        反應: "Fuchsia",
      };
      const id = row["id/int"];
      const title = row["title/string"];
      const weight = row["weight/int"];
      const attackType = row["attackType/string"];
      const outsidePower = row["outsidePower/int"];
      const insidePower = row["insidePower/int"];
      const skillType = row["skillType/string"];
      const skillCost = row["skillCost/string"];
      const skillName = row["skillName/string"];
      const skillText = row["skillText/string"];
      const skillMana = row["skillMana/string"];
      $("#input").append(
        $(
          cardView({
            id,
            title,
            weight,
            attackType,
            outsidePower,
            insidePower,
            skillType,
            skillCost,
            skillName,
            skillText,
            skillMana,
            color: colorMapping[skillType],
          })
        )
      );
    });
  }

  function build() {
    return Promise.all(
      $("#input")
        .children()
        .map((k, v) => {
          return html2canvas(v);
        })
    ).then((imgs) => {
      const zip = new JSZip();

      for (let i in imgs) {
        const img = imgs[i];
        const info = rows[i];
        const id = info["id/int"];
        console.log(i, id);
        if (false) {
          $("#output").append(
            `<a href=${img.toDataURL()} download=${id}.png>
            <img src=${img.toDataURL()}>
          </a>`
          );
        }
        const imgData = img.toDataURL();
        const imgB64 = imgData.substring(imgData.indexOf(",") + 1);
        zip.file(`${id}.png`, imgB64, { base64: true });
      }

      zip
        .generateAsync({
          type: "blob", // 壓縮型別
          compression: "DEFLATE", // STORE：預設不壓縮 DEFLATE：需要壓縮
          compressionOptions: {
            level: 9, // 壓縮等級1~9    1壓縮速度最快，9最優壓縮方式
            // [使用一張圖片測試之後1和9壓縮的力度不大，相差100K左右]
          },
        })
        .then(function (content) {
          // 壓縮的結果為blob型別
          $(document.body).append(
            `<a href=${URL.createObjectURL(
              content
            )} download=build.zip>build.zip</a>`
          );
        });
    });
  }

  draw();
  build();
</script>
